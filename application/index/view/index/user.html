<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>登录</title>
    <link rel="stylesheet" href="/tp5/public/static/plugins/bootstrap/css/bootstrap.min.css">
    <!-- Fontawesome CSS -->
    <link href="/tp5/public/static/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!--  Feather Icon CSS -->
    <link href="/tp5/public/static/icon/feather/css/feather.css" rel="stylesheet">
    <link rel="stylesheet" href="/tp5/public/static/plugins/bootstrap-table/bootstrap-table.min.css">
    <link href="/tp5/public/static/css/cust.css" rel="stylesheet">
    <style>
        .profile-avatar-container {
            position: relative;
            width: 100px;
            margin: 0 auto;
        }

        .profile-avatar-container .profile-user-img {
            display: none;
            width: 100px;
            height: 100px;
        }

        .profile-avatar-container .profile-avatar-text {
            display: none;
        }

        .profile-avatar-container:hover .profile-avatar-text {
            display: block;
            position: absolute;
            height: 100px;
            width: 100px;
            background: #444;
            opacity: .6;
            color: #fff;
            top: 0;
            left: 0;
            line-height: 100px;
            text-align: center;
        }

        .profile-avatar-container button {
            position: absolute;
            top: 0;
            left: 0;
            width: 100px;
            height: 100px;
            opacity: 0;
        }

        .avatar-icon {
            margin: 20px auto;
            width: 80px;
            height: 80px;
            font-size: 40px;
            border-radius: 80px;
            color: #999;
            background-color: #d2d2d2;
            z-index: 9;
            text-align: center;
            line-height: 80px;
        }
        input[type='file']{
            display: none;
        }
        table td:last-of-type{
            white-space: nowrap;
        }
    </style>
</head>

<body class="user-info">
    <div class="">
        <div class="row animated fadeInRight">
            <div class="col-md-4">
                <div class="box box-primary">
                    <div class="panel-heading">
                        个人资料 </div>
                    <div class="panel-body">

                        <form id="update-form" role="form" data-toggle="validator" method="POST"
                            action="/qGPaHuRfYy.php/general.profile/update" class="nice-validator n-default n-bootstrap"
                            novalidate="novalidate">
                            <input type="hidden" name="__token__" value="d0ece5bbdf37002094e2c80b270a56a6"> <input
                                type="hidden" id="c-avatar" name="row[avatar]"
                                value="http://fastadmin.heima.com/assets/img/avatar.png">
                            <div class="box-body box-profile">

                                <div class="profile-avatar-container">
                                    <input type="file" name="avatar-file" accept="image/*">
                            <img class="profile-user-img img-responsive img-circle" src="" alt="">

                                    <div class="avatar-icon"><i class="feather icon-user"></i></div>
                                    <div class="profile-avatar-text img-circle">点击编辑</div>
                                    <button type="button" id="faupload-avatar" class="faupload dz-clickable"
                                        data-input-id="c-avatar" initialized="true"><i
                                            class="fa fa-upload dz-message"></i> 上传</button>
                                </div>

                                <h3 class="profile-username text-center">admin</h3>

                                <div class="form-group">
                                    <label for="username" class="control-label">用户名:</label>
                                    <input type="text" class="form-control" id="username" name="username1"
                                        value="admin" disabled="">
                                </div>
                                <div class="form-group">
                                    <label for="mobile" class="control-label">手机:</label>
                                    <input type="text" class="form-control" id="mobile" name="mobile" value=""
                                        disabled="">
                                </div>
                                <div class="form-group">
                                    <label for="email" class="control-label">邮箱:</label>
                                    <input type="text" class="form-control" id="email" name="email"
                                        value="">
                                </div>
                                <div class="form-group">
                                    <label for="nickname" class="control-label">昵称:</label>
                                    <input type="text" class="form-control" id="username" name="username"
                                        value="">
                                </div>
                                <div class="form-group">
                                    <label for="password" class="control-label">密码:</label>
                                    <input type="password" class="form-control" id="password" placeholder="不修改密码请留空"
                                        autocomplete="new-password" name="password" value="">
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary">提交</button>
                                    <button type="reset" class="btn btn-default">重置</button>
                                </div>

                            </div>
                        </form>
                    </div>
                </div>

            </div>
            <div class="col-md-8">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#one" data-toggle="tab"><i class="fa fa-list"></i> 操作日志</a></li>
                </ul>
                <div class="bootstrap-table">
                    <table id="histTable"></table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.15.0/umd/popper.js"></script>
    <script src="/tp5/public/static/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="/tp5/public/static/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="/tp5/public/static/plugins/bootstrap-table/bootstrap-table-zh-CN.min.js"></script>
    <script>
        $(function(){

            $.get("/tp5/public/index.php/index/Index/userInfo",function(res){
                if(res && res.rows){
                    $('input[name=email]').val(res.rows.email);
                    $('input[name=username]').val(res.rows.username);
                    var imgSrc = res.rows.photourl;
                    $(".avatar-icon").hide();
                    $('.profile-user-img').attr('src',imgSrc).show();
                }
            },'json');

            $("#update-form").on("submit",function(){

                var data = {
                    email: $('input[name="email"]').val(),
                    username: $('input[name="username"]').val(),
                    password: $('input[name="password"]').val()
                }
                let that = this;
                $.ajax({
                    url: "/tp5/public/index.php/index/Index/update",
                    type: "POST",
                    data: data,
                    dataType: "json",
                    success: function (result) {
                        if(result.status == 'success'){
                            alert(result.message);
                        }else{

                        }
                    },
                });




                return false;
            })





            $("#faupload-avatar").on("click",function(){ //点击上传头像
                $("input[name='avatar-file']").click();
            });
            $("input[name='avatar-file']").change(e=>{
                console.log(e,222222222);
                var file = event.target.files[0];
                //todo 此处可以发送ajax处理图片上传
                var data = new FormData();
                data.append('photo',file);

                $.ajax({
                    url:'/tp5/public/index.php/index/USer/avatar',
                    type:'POST',
                    data: data,
                    cache:false,
                    contentType: false,
                    processData: false,
                    dataType:'json',
                    success: function(res){
                        console.log(res,'上传成功');
                        let imgSrc = res.target_directory
                        $(".avatar-icon").hide();
                        $('.profile-user-img').attr('src',imgSrc).show();
                        parent.setAvatar(imgSrc);
                       
                    },
                    error: function(err){
                       // console.log(err,'上传错误');
                        alert('上传错误');
                    }
                })


                //下边是上传预览代码
/*                 var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(res) {
                    var imgSrc = res.target.result;
                    $(".avatar-icon").hide();
                    $('.profile-user-img').attr('src',imgSrc).show();
                    parent.setAvatar(imgSrc);
                }; */
            });





            setTable();
        function setTable() {

            $('#histTable').bootstrapTable({
                url: "/tp5/public/index.php/index/Index/loginInfo",
                striped: true,
                    pagination: true,       // 开启分页
                    sidePagination: 'server',// 分页在客户端进行
                    pageNumber:1,
                    pageSize: 10,
                    showColumns: true,
                    showToggle: true,
                    showExport: true,
                    exportDataType:'all',
                    exportTypes:['json', 'xml', 'csv', 'txt', 'sql', 'excel', 'pdf'],
                columns: [{
                    title: '序号',
                    formatter: function(value,row,index){
                        var options = $('#histTable').bootstrapTable('getOptions');
                        return options.pageSize * (options.pageNumber - 1) + index + 1;
                    }
                }, {
                    field: 'title',
                    title: '标题'
                }, {
                    field: 'url',
                    title: '链接'
                }, {
                    title: 'ip',
                    field: 'ip'
                }, {
                    title: '操作时间',
                    field: 'logintime'
                }]
            });
        }
        })

    </script>
</body>

</html>